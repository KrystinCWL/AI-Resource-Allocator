{% extends "base.html" %}
{% block body %}

<div class="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-icon">
      <img src="https://cic.ndu.edu/Portals/74/CICSealWeb.png" alt="logo" />
    </div>
    <div>
      <h1>CIC Course</h1>
      <p>Admin Tools</p>
    </div>
  </div>

  <h2 class="nav-section-title">Admin Tools</h2>
  <a class="nav-button" href="{{ url_for('admin_dashboard') }}">ğŸ‘¥ Submitted Preferences</a>
  <a class="nav-button active"><span class="icon-cloud-upload"></span>Upload Files</a>
  <a class="nav-button" href="{{ url_for('admin_schedule') }}">ğŸ“‹ View Schedule</a>
  <a class="nav-button" href="{{ url_for('admin_analysis') }}">ğŸ”· AI Analysis</a>
  <a class="nav-button" href="{{ url_for('logout') }}">Logout</a>

  <div class="sidebar-footer">
    <div class="user-info">Current Semester</div>
    <div class="username">{{ (active_semester and active_semester.semesterId) or 'â€”' }}</div>
  </div>
</div>

<div class="main-content">
    <div class="header">
      <div class="header-left">
        <h2>Upload Instructor Preferences</h2>
        <p>Import instructor submissions from a CSV or Excel file, then trigger the AI scheduler.</p>
      </div>
    <div class="actions-row button-stack" style="max-width:260px; margin-left:auto; align-items:stretch;">
      <form method="post" action="{{ url_for('admin_generate') }}" class="full">
        <button class="btn-primary full" type="submit">âš™ï¸ Generate Schedule</button>
      </form>
      <form method="get" action="{{ url_for('admin_schedule') }}" class="full" style="margin:0;">
        <button class="btn-primary full" type="submit">ğŸ“‹ View Schedule</button>
      </form>
      <a class="btn-primary full" href="{{ url_for('admin_schedule', download='csv') }}">â¬‡ï¸ Download Schedule</a>
    </div>
    </div>

  <div class="content-area">
    {% if upload_error %}
    <div class="badge red" style="margin-bottom: 16px;">{{ upload_error }}</div>
    {% elif upload_result %}
    <div class="badge green" style="margin-bottom: 16px;">
      Uploaded {{ upload_result.total_rows }} rows â€” saved {{ upload_result.imported_rows }} preference{{ 's' if upload_result.imported_rows != 1 else '' }}.
    </div>
    {% endif %}

    <div class="form-section upload-card">
      <div class="upload-header">
        <div class="icon-cloud-upload-dark"></div>
        <div>
          <h3 style="margin:0;">Upload preference data</h3>
          <p style="color:#94a3b8; margin:4px 0 0;">Select a CSV or Excel file with UserEmail, CourseId, and priority_rank columns.</p>
        </div>
      </div>
      <form method="post" enctype="multipart/form-data" style="margin-top: 8px;">
        <label class="dropzone">
          <div class="dz-icon"><span class="icon-cloud-upload-dark"></span></div>
          <div class="dz-title">Choose a file to upload</div>
          <div class="dz-sub">Accepted formats: CSV, XLSX. Max 10MB.</div>
          <input type="file" name="preferences_file" accept=".csv,.xlsx,.xls" required id="preferencesFileInput">
        </label>
        <div id="selectedFileWrap" style="margin-top:12px; border:1px solid #e2e8f0; border-radius:10px; padding:10px 12px; background:#f8fafc;">
          <div style="font-weight:600; color:#334155; margin-bottom:6px;">Selected file</div>
          <div style="display:flex; align-items:center; gap:10px; color:#475569; font-size:0.95rem;">
            <span style="font-size:20px; color:#3b82f6;">ğŸ“„</span>
            <span id="selectedFilename">No file selected yet.</span>
          </div>
        </div>
        <div style="margin-top:12px; text-align:right;">
          <button class="btn-primary" type="submit"><span class="icon-cloud-upload"></span>Upload File</button>
        </div>
      </form>
    </div>

    {% if upload_result and upload_result.uploaded_filename %}
    <div class="form-section" style="margin-top:12px;">
      <h3 style="margin:0 0 6px 0;">Last uploaded file</h3>
      <p style="margin:0; color:#475569;">{{ upload_result.uploaded_filename }}</p>
    </div>
    {% endif %}

    {% if upload_result %}
    <div class="form-section" style="margin-top: 20px;">
      <h3>Import summary</h3>
      <ul style="margin-top: 12px; color:#475569;">
        <li>Total rows processed: {{ upload_result.total_rows }}</li>
        <li>Saved preferences: {{ upload_result.imported_rows }}</li>
        <li>Skipped (invalid data): {{ upload_result.skipped_invalid }}</li>
        <li>Skipped (missing user match): {{ upload_result.skipped_missing_user }}</li>
        <li>Deduplicated rows (kept best priority): {{ upload_result.deduped }}</li>
      </ul>
      {% if upload_result.missing_emails %}
      <div style="margin-top:12px; color:#b45309; background:#fef3c7; padding:12px; border-radius:8px;">
        <strong>Missing accounts:</strong>
        <span>The following emails were not found in the system: {{ upload_result.missing_emails | join(', ') }}.</span>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <div class="form-section" style="margin-top: 20px;">
      <h3>2. Generate the AI schedule</h3>
      <p style="color:#64748b;">After uploading the latest preferences, click <strong>Generate Schedule</strong> to run the AI-based pairing algorithm.</p>
      <form method="post" action="{{ url_for('admin_generate') }}" style="margin-top: 12px;">
        <button class="btn-primary" type="submit">âš™ï¸ Generate Schedule</button>
      </form>
      <p style="color:#94a3b8; font-size: 0.9rem; margin-top: 8px;">The generated schedules will be available in the <strong>View Schedule</strong> page and can be evaluated through the <strong>AI Analysis</strong> report.</p>
    </div>
  </div>
</div>

<script>
  (function () {
    const input = document.getElementById('preferencesFileInput');
    const label = document.getElementById('selectedFilename');
    if (input && label) {
      input.addEventListener('change', function () {
        if (this.files && this.files.length > 0) {
          label.textContent = this.files[0].name;
        } else {
          label.textContent = 'No file selected yet.';
        }
      });
    }
  })();
</script>

{% endblock %}
